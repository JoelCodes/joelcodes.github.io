---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';
import Button from '../../components/ui/Button.astro';
import { getCollection } from 'astro:content';
import { readingTime } from 'reading-time-estimator';

// Get published posts, sorted newest first
const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});

const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Get unique tags from all posts
const allTags = [...new Set(sortedPosts.flatMap(post => post.data.tags))];

// Calculate reading time for each post
const postsWithMeta = sortedPosts.map((post) => {
  const stats = readingTime(post.body || '', { wordsPerMinute: 265 });
  return { ...post, readingTime: Math.ceil(stats.minutes) };
});
---

<BaseLayout
  title="Blog | Joel Shinness"
  description="Thoughts on web development, automation, and AI for small businesses. Practical insights to help you work smarter."
>
  <main class="py-16 px-4">
    <div class="max-w-7xl mx-auto">
      <!-- Page header -->
      <header class="text-center mb-12">
        <h1 class="font-heading text-4xl md:text-5xl font-bold uppercase mb-4">Blog</h1>
        <p class="text-lg text-text-muted-light dark:text-text-muted-dark max-w-2xl mx-auto">
          Practical insights on automation, AI, and custom software for small businesses.
          Learn how to work smarter, not harder.
        </p>
      </header>

      <!-- Filter buttons -->
      <div class="flex flex-wrap justify-center gap-3 mb-12" id="filter-container">
        <Button
          variant="turquoise"
          size="md"
          data-filter="all"
          data-active="true"
          class="filter-btn rounded-full"
        >
          All Posts
        </Button>
        {allTags.map((tag) => (
          <Button
            variant="outline"
            size="md"
            data-filter={tag}
            class="filter-btn rounded-full"
          >
            {tag}
          </Button>
        ))}
      </div>

      <!-- Blog card grid -->
      <section id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {postsWithMeta.map((post, index) => (
          <BlogCard
            title={post.data.title}
            slug={post.id}
            pubDate={post.data.pubDate}
            description={post.data.description}
            featuredImage={post.data.featuredImage}
            tags={post.data.tags}
            readingTime={post.readingTime}
            data-index={index}
          />
        ))}
      </section>

      <!-- Load more button (shown only if more than 9 posts) -->
      {postsWithMeta.length > 9 && (
        <div class="text-center mt-12">
          <button
            id="load-more-btn"
            class="px-8 py-3 rounded-full transition-colors duration-200 bg-turquoise hover:bg-turquoise-hover text-bg-dark border-[3px] border-text-light dark:border-text-dark font-bold"
            onclick="loadMorePosts()"
          >
            Load More Posts
          </button>
        </div>
      )}
    </div>
  </main>

  <script is:inline>
    // Track how many posts are visible
    const INITIAL_POSTS = 9;
    const POSTS_PER_LOAD = 6;
    let visiblePosts = INITIAL_POSTS;
    let currentFilter = 'all';

    function filterSelection(tag) {
      currentFilter = tag;
      const cards = document.getElementsByClassName('blog-card');

      for (let i = 0; i < cards.length; i++) {
        cards[i].classList.remove('show');

        const cardTags = cards[i].getAttribute('data-tags');
        const tagsArray = cardTags ? cardTags.split(',') : [];

        if (tag === 'all' || tagsArray.includes(tag)) {
          cards[i].classList.add('show');
        }
      }

      // Reset load more state when filtering
      visiblePosts = INITIAL_POSTS;
      updateLoadMoreVisibility();
      setActiveButton(tag);
    }

    function setActiveButton(tag) {
      const buttons = document.querySelectorAll('.filter-btn');
      buttons.forEach(btn => {
        const isActive = btn.getAttribute('data-filter') === tag;
        btn.setAttribute('data-active', isActive ? 'true' : 'false');
        // Toggle Button CSS classes for variant swap
        if (isActive) {
          btn.classList.remove('btn-outline');
          btn.classList.add('btn-turquoise');
        } else {
          btn.classList.remove('btn-turquoise');
          btn.classList.add('btn-outline');
        }
      });
    }

    function loadMorePosts() {
      visiblePosts += POSTS_PER_LOAD;
      filterSelection(currentFilter);
      updateLoadMoreVisibility();
    }

    function updateLoadMoreVisibility() {
      const loadMoreBtn = document.getElementById('load-more-btn');
      if (loadMoreBtn) {
        const totalCards = document.getElementsByClassName('blog-card').length;
        if (visiblePosts >= totalCards) {
          loadMoreBtn.style.display = 'none';
        } else {
          loadMoreBtn.style.display = 'inline-block';
        }
      }
    }

    // Add click handlers via event delegation for filter buttons
    document.getElementById('filter-container').addEventListener('click', (e) => {
      const btn = e.target.closest('.filter-btn');
      if (btn) {
        const filter = btn.getAttribute('data-filter');
        filterSelection(filter);
      }
    });

    // Initialize with all posts visible
    filterSelection('all');
  </script>
</BaseLayout>
