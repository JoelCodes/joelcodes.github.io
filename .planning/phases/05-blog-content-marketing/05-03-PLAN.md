---
phase: 05-blog-content-marketing
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/pages/blog/[slug].astro
  - src/components/TableOfContents.astro
  - src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "User can read full blog post content with MDX rendering"
    - "Code blocks have syntax highlighting with copy button"
    - "Table of contents shows headings and highlights current section while scrolling"
    - "Reading experience uses narrow width (65ch) for optimal readability"
  artifacts:
    - path: "src/pages/blog/[slug].astro"
      provides: "Dynamic blog post page with content rendering"
      contains: "getStaticPaths"
    - path: "src/components/TableOfContents.astro"
      provides: "Sticky sidebar TOC with active section highlighting"
      contains: "IntersectionObserver"
  key_links:
    - from: "src/pages/blog/[slug].astro"
      to: "astro:content"
      via: "getCollection and render()"
      pattern: "render\\(\\)"
    - from: "src/pages/blog/[slug].astro"
      to: "src/components/TableOfContents.astro"
      via: "component with headings prop"
      pattern: "TableOfContents.*headings"
---

<objective>
Create the blog post reading experience with narrow content width, sticky TOC, and MDX rendering.

Purpose: Provide an excellent reading experience for long-form content. Sticky TOC helps navigation, narrow width improves readability, and Expressive Code makes technical content accessible.

Output: Blog post pages at /blog/[slug] with MDX content, syntax-highlighted code blocks with copy buttons, and sticky table of contents.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-blog-content-marketing/05-CONTEXT.md
@.planning/phases/05-blog-content-marketing/05-RESEARCH.md
@.planning/phases/05-blog-content-marketing/05-01-SUMMARY.md
@src/layouts/BaseLayout.astro
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TableOfContents component with Intersection Observer</name>
  <files>src/components/TableOfContents.astro, src/styles/global.css</files>
  <action>
Create `src/components/TableOfContents.astro` that:

Props interface:
```typescript
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}
```

Implementation:
1. Filter to show only h2 and h3 (depth 2 and 3)
2. Render nested list with indentation for h3 under h2
3. Each item links to `#${heading.slug}`
4. Apply `toc-${depth}` class for styling indentation
5. Include client-side script for active section highlighting

Styling (add to component or global.css):
```css
.toc {
  position: sticky;
  top: 6rem; /* Below sticky header */
  max-height: calc(100vh - 8rem);
  overflow-y: auto;
}

.toc a {
  display: block;
  padding: 0.25rem 0;
  color: var(--color-text-muted-light);
  transition: color 0.2s;
}

.dark .toc a {
  color: var(--color-text-muted-dark);
}

.toc a:hover,
.toc a.active {
  color: var(--color-accent-teal);
}

.toc-3 {
  padding-left: 1rem;
  font-size: 0.875rem;
}
```

JavaScript for active highlighting (inline script at component end):
```javascript
const observer = new IntersectionObserver(
  (entries) => {
    entries.forEach(entry => {
      const id = entry.target.getAttribute('id');
      const tocLink = document.querySelector(`.toc a[href="#${id}"]`);

      if (entry.isIntersecting) {
        document.querySelectorAll('.toc a').forEach(link => link.classList.remove('active'));
        tocLink?.classList.add('active');
      }
    });
  },
  { rootMargin: '-80px 0px -80% 0px' }
);

document.querySelectorAll('article h2[id], article h3[id]').forEach(heading => {
  observer.observe(heading);
});
```

Hide TOC on mobile (< 1024px) using Tailwind `hidden lg:block`.
  </action>
  <verify>
Component can be imported and rendered with sample headings array.
TOC renders with correct structure and links.
  </verify>
  <done>
TableOfContents.astro exists with:
- Sticky positioning below header
- h2/h3 headings as links
- IntersectionObserver for active section highlighting
- Teal accent color for active/hover states
- Hidden on mobile, visible on lg+ screens
  </done>
</task>

<task type="auto">
  <name>Task 2: Create blog post page with reading experience</name>
  <files>src/pages/blog/[slug].astro, src/styles/global.css</files>
  <action>
Create `src/pages/blog/[slug].astro` with:

1. **getStaticPaths** - Generate routes for all posts
```typescript
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true;
  });

  return posts.map(post => ({
    params: { slug: post.id },
    props: { post },
  }));
}
```

2. **Page layout** - Two-column on desktop, single column on mobile
   - Left: Sticky TOC (hidden on mobile)
   - Center: Main content with narrow width (65ch)
   - Use CSS Grid: `grid grid-cols-1 lg:grid-cols-[200px_1fr_200px]`

3. **Post header** - Above content
   - Title (h1, large)
   - Metadata row: date + reading time + tags
   - Featured image (full width within content area)

4. **Content area** - Narrow width for readability
   - Max width 65ch using `max-w-prose` or explicit `max-w-[65ch]`
   - Use `render()` to get Content component and headings
   - Pass headings to TableOfContents

5. **MDX rendering**
```typescript
const { post } = Astro.props;
const { Content, headings } = await post.render();
```

6. **Prose styling** - Add to global.css for MDX content
```css
/* Blog post prose styling */
.prose h2 {
  font-family: var(--font-heading);
  font-size: 1.5rem;
  font-weight: 700;
  margin-top: 2rem;
  margin-bottom: 1rem;
}

.prose h3 {
  font-family: var(--font-heading);
  font-size: 1.25rem;
  font-weight: 600;
  margin-top: 1.5rem;
  margin-bottom: 0.75rem;
}

.prose p {
  margin-bottom: 1rem;
  line-height: 1.75;
}

.prose ul, .prose ol {
  margin-bottom: 1rem;
  padding-left: 1.5rem;
}

.prose li {
  margin-bottom: 0.5rem;
}

.prose a {
  color: var(--color-accent-teal);
  text-decoration: underline;
}

.prose strong {
  font-weight: 600;
}

.prose blockquote {
  border-left: 4px solid var(--color-accent-teal);
  padding-left: 1rem;
  font-style: italic;
  color: var(--color-text-muted-light);
}

.dark .prose blockquote {
  color: var(--color-text-muted-dark);
}

/* Code blocks get Expressive Code styling automatically */
.prose pre {
  margin: 1.5rem 0;
  border-radius: 0.5rem;
}

/* Images break out to full width with caption support */
.prose img {
  width: 100%;
  border-radius: 0.5rem;
  margin: 1.5rem 0;
}

.prose figcaption {
  text-align: center;
  font-size: 0.875rem;
  color: var(--color-text-muted-light);
  margin-top: -1rem;
  margin-bottom: 1.5rem;
}

.dark .prose figcaption {
  color: var(--color-text-muted-dark);
}
```

7. **Back link** - "‚Üê Back to Blog" at top and/or bottom
  </action>
  <verify>
Run `npm run dev` and visit http://localhost:4321/blog/getting-started-with-automation
- Post content renders correctly
- Code block has syntax highlighting and copy button
- TOC appears on desktop with correct headings
- TOC highlights active section while scrolling
- Content has narrow width (65ch)
- Dark mode works
  </verify>
  <done>
Blog post page exists at /blog/[slug] with:
- Post title, date, reading time, tags in header
- MDX content rendered with prose styling
- Syntax highlighted code blocks with copy button (via Expressive Code)
- Sticky TOC on desktop with active section highlighting
- Narrow reading width (65ch) for optimal readability
- Responsive layout (TOC hidden on mobile)
  </done>
</task>

</tasks>

<verification>
1. Visit /blog/getting-started-with-automation - page loads
2. Post title, date, reading time visible in header
3. MDX content renders with proper typography
4. Code block has syntax highlighting (colored)
5. Code block has copy button (from Expressive Code)
6. TOC visible on desktop (1024px+), hidden on mobile
7. Scrolling changes active TOC item
8. Content width is narrow (65ch), centered
9. Dark mode styling works correctly
10. "Back to Blog" link works
</verification>

<success_criteria>
- Dynamic routing works for all blog posts
- MDX content renders correctly with prose styling
- Code blocks have Expressive Code features (syntax highlighting, copy button, language label)
- Sticky TOC with active section highlighting on desktop
- Narrow reading width (65ch) provides good readability
- Responsive design (single column on mobile, TOC on desktop)
</success_criteria>

<output>
After completion, create `.planning/phases/05-blog-content-marketing/05-03-SUMMARY.md`
</output>
