---
phase: 20-contact-form-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/pages/contact.astro
autonomous: true
user_setup:
  - service: n8n
    why: "Webhook for form submissions"
    env_vars:
      - name: PUBLIC_N8N_WEBHOOK_URL
        source: "n8n Dashboard -> Workflows -> Webhook node -> Copy Production URL"
    dashboard_config:
      - task: "Create webhook-triggered workflow"
        location: "n8n -> New Workflow -> Add Webhook trigger node"
      - task: "Set CORS allowed origins"
        location: "Webhook node settings -> Allowed Origins: https://joelshinness.com,http://localhost:4321"

must_haves:
  truths:
    - "User can fill out enhanced form with all fields (Name, Email, Company, Challenges, Solutions, Budget, Timeline, Message)"
    - "User submitting valid form is redirected to /thank-you"
    - "User sees inline error messages for invalid required fields"
    - "User sees fallback email option on network failure"
    - "Form submits JSON payload to n8n webhook URL"
  artifacts:
    - path: "src/pages/contact.astro"
      provides: "Enhanced contact form with all lead gen fields"
      contains: "PUBLIC_N8N_WEBHOOK_URL"
  key_links:
    - from: "src/pages/contact.astro"
      to: "n8n webhook"
      via: "fetch POST with JSON"
      pattern: "fetch.*webhookURL"
    - from: "src/pages/contact.astro"
      to: "/thank-you"
      via: "window.location.href redirect"
      pattern: "window.location.href.*thank-you"
    - from: "src/pages/contact.astro"
      to: "src/components/ui/CheckboxGroup.astro"
      via: "component import"
      pattern: "import.*CheckboxGroup"
---

<objective>
Enhance the contact form with all lead generation fields, n8n webhook integration, and improved submission feedback.

Purpose: Transform the existing Formspree-based form into an optimized lead qualification form that submits to n8n for workflow automation, with proper success redirect and error handling.
Output: Updated contact.astro with full field set, webhook integration, and /thank-you redirect.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-contact-form-enhancement/20-CONTEXT.md
@.planning/phases/20-contact-form-enhancement/20-RESEARCH.md
@.planning/phases/20-contact-form-enhancement/20-01-SUMMARY.md

# Source file to modify
@src/pages/contact.astro
@src/components/ui/CheckboxGroup.astro
@src/components/ui/Input.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new form fields</name>
  <files>src/pages/contact.astro</files>
  <action>
Add the new fields to the contact form. Keep existing Name, Email, Message fields. Replace "Project Type" dropdown with the new field set.

Field order (from CONTEXT.md - group related fields logically):
1. Name (required) - keep existing
2. Email (required) - keep existing
3. Company (optional) - NEW Input type="text" placeholder="Company name (if applicable)"
4. Challenges (optional) - NEW Input as="textarea" placeholder with guiding questions: "What challenge are you facing? What's your timeline?"
5. Solutions (optional) - NEW CheckboxGroup with options:
   - AI
   - Automations
   - Web Apps
   - Consultation
   - Not Sure
   (Non-exclusive, no selection required)
6. Budget (optional) - NEW Input as="select" with options:
   - "" (Select budget range - optional)
   - Under $2K
   - $2K-5K
   - $5K-10K
   - $10K-25K
   - $25K+
7. Timeline (optional) - NEW Input as="select" with options:
   - "" (Select timeline - optional)
   - This week
   - This month
   - This quarter
   - Flexible
8. Message (required) - keep existing, update placeholder to: "Tell me more about your project..."

Import CheckboxGroup at top of file:
```astro
import CheckboxGroup from '../components/ui/CheckboxGroup.astro';
```

Add labels for optional fields with "(optional)" suffix in muted text.
  </action>
  <verify>
1. Run `npm run dev` and visit http://localhost:4321/contact
2. All 8 fields visible: Name, Email, Company, Challenges, Solutions checkboxes, Budget, Timeline, Message
3. Solutions shows 5 checkboxes in neobrutalist style
4. Budget and Timeline are dropdowns with correct options
  </verify>
  <done>Contact form displays all 8 fields with proper types, labels, and optional indicators</done>
</task>

<task type="auto">
  <name>Task 2: Implement n8n webhook submission with redirect</name>
  <files>src/pages/contact.astro</files>
  <action>
Update the form submission handler to:
1. POST JSON to n8n webhook instead of Formspree
2. Redirect to /thank-you on success
3. Show email fallback on network failure

Changes to existing script:

1. Replace Formspree action with webhook URL:
```javascript
const webhookURL = import.meta.env.PUBLIC_N8N_WEBHOOK_URL || 'https://placeholder.n8n.webhook';
```

2. Update form submit handler to build JSON payload:
```javascript
const formData = new FormData(form);
const payload = {
  name: formData.get('name'),
  email: formData.get('email'),
  company: formData.get('company') || undefined, // Omit if empty
  challenges: formData.get('challenges') || undefined,
  solutions: formData.getAll('solutions'), // Array from checkboxes
  budget: formData.get('budget') || undefined,
  timeline: formData.get('timeline') || undefined,
  message: formData.get('message')
};

// Filter out undefined/empty optional fields
const cleanPayload = Object.fromEntries(
  Object.entries(payload).filter(([key, value]) =>
    value !== undefined && value !== '' &&
    !(Array.isArray(value) && value.length === 0)
  )
);
```

3. Change fetch to POST JSON:
```javascript
const response = await fetch(webhookURL, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(cleanPayload)
});
```

4. Replace showSuccessMessage() with redirect:
```javascript
// Success - redirect to thank you page
window.location.href = '/thank-you';
```

5. Keep network error fallback but update message:
```javascript
showFormError('Could not send message. Email me directly at joel@joelshinness.com');
```

6. Remove the success-template since we redirect instead.

Remove form action and method attributes (submission is fully JavaScript-controlled):
```html
<form id="contact-form" class="space-y-6" novalidate>
```
  </action>
  <verify>
1. Run `npm run dev`
2. Open browser DevTools Network tab
3. Fill out form with valid data and submit
4. Observe: POST request to webhook URL with JSON payload
5. On success (or placeholder 404): should attempt redirect to /thank-you
6. Test network failure: disconnect wifi, submit form, see fallback message
  </verify>
  <done>Form submits JSON to n8n webhook URL and redirects to /thank-you on success</done>
</task>

<task type="auto">
  <name>Task 3: Update validation for new fields</name>
  <files>src/pages/contact.astro</files>
  <action>
Update the validation configuration to handle new required/optional fields.

Required fields need validation:
- name (existing, keep as-is)
- email (existing, keep as-is)
- message (existing, remove minlength requirement per CONTEXT.md decision)

Remove minlength from message field HTML:
```astro
<Input
  as="textarea"
  variant="yellow"
  id="message"
  name="message"
  required
  rows={6}
  placeholder="Tell me more about your project..."
/>
```

Update validationConfig to remove tooShort check for message:
```javascript
message: {
  element: document.getElementById('message') as HTMLTextAreaElement,
  errorElement: document.getElementById('message-error') as HTMLSpanElement,
  messages: {
    valueMissing: 'Please enter a message.',
    typeMismatch: '',
    tooShort: '' // No minimum
  }
}
```

Optional fields (company, challenges, solutions, budget, timeline) do NOT need validation entries - they are optional.
  </action>
  <verify>
1. Run `npm run dev`
2. Submit empty form - see errors only on Name, Email, Message
3. Fill Name and Email, leave Message empty, submit - see Message error
4. Fill all required fields, submit - form submits (no errors on optional fields)
  </verify>
  <done>Validation shows errors only for required fields (Name, Email, Message) with no minimum character requirements on Message</done>
</task>

</tasks>

<verification>
- Form displays all 8 fields with correct types and labels
- Solutions checkboxes render in neobrutalist style
- Form submits JSON payload to webhook URL
- Success redirects to /thank-you
- Network failure shows email fallback
- Required field validation works (Name, Email, Message only)
- `npm run build` completes without errors
</verification>

<success_criteria>
1. User can fill all 8 form fields including 5 solution checkboxes
2. Valid submission redirects to /thank-you page
3. Invalid submission shows inline field errors
4. Network error shows fallback contact email
5. JSON payload includes all non-empty fields, uses getAll() for checkboxes
</success_criteria>

<output>
After completion, create `.planning/phases/20-contact-form-enhancement/20-02-SUMMARY.md`
</output>
